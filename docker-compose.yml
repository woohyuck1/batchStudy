services:
  # Zookeeper: Kafka의 메타데이터 관리 및 브로커 조정을 담당
  zookeeper:
    image: confluentinc/cp-zookeeper:7.9.0
    # 컨테이너 이름 지정
    container_name: zookeeper
    environment:
      # Zookeeper 클라이언트 포트 (기본값: 2181)
      ZOOKEEPER_CLIENT_PORT: 2181
      # Zookeeper의 기본 시간 단위 (밀리초) - 세션 타임아웃 계산에 사용
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      # 호스트 포트:컨테이너 포트 매핑 (외부에서 2181로 접속 가능)
      - "2181:2181"
    networks:
      # Kafka와 통신하기 위한 네트워크
      - kafka-network
    healthcheck:
      # 헬스 체크: netcat으로 2181 포트 연결 확인
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      # 10초마다 헬스 체크 실행
      interval: 10s
      # 5초 내 응답 없으면 타임아웃
      timeout: 5s
      # 5번 실패 시 unhealthy로 판단
      retries: 5

  # Kafka: 메시지 브로커 (메시지 큐 시스템)
  kafka:
    image: confluentinc/cp-kafka:7.9.0
    # 컨테이너 이름 지정
    container_name: kafka
    depends_on:
      # Zookeeper가 healthy 상태가 된 후에만 Kafka 시작
      zookeeper:
        condition: service_healthy
    ports:
      # 외부 접속용 포트 (애플리케이션에서 localhost:9092로 접속)
      - "9092:9092"
      # 내부 통신용 포트 (다른 컨테이너와 통신)
      - "9093:9093"
    environment:
      # Kafka 브로커 고유 ID (클러스터 내에서 유일해야 함)
      KAFKA_BROKER_ID: 1
      # Zookeeper 연결 주소 (컨테이너 이름으로 접속)
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      
      # KAFKA_ADVERTISED_LISTENERS : Kafka 브로커가 자기 자신을 외부와 내부에 알리는 포트
      # - PLAINTEXT: 외부 클라이언트 접속용
      # - PLAINTEXT_INTERNAL: 내부 브로커 간 통신용
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092,PLAINTEXT_INTERNAL://kafka:10516
      # 리스너별 보안 프로토콜 매핑 (현재는 모두 PLAINTEXT = 암호화 없음)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      # 브로커 간 통신에 사용할 리스너 이름
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      # 오프셋 토픽의 복제 팩터 (단일 브로커이므로 1)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      # Zookeeper와 통신하기 위한 네트워크
      - kafka-network
    healthcheck:
      # 헬스 체크: Kafka 브로커 API 버전 확인
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      # 10초마다 헬스 체크 실행
      interval: 10s
      # 5초 내 응답 없으면 타임아웃
      timeout: 5s
      # 5번 실패 시 unhealthy로 판단
      retries: 5

  # Kafka UI: Kafka 클러스터를 관리하고 모니터링하는 웹 UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    # 컨테이너 이름 지정
    container_name: kafka-ui
    depends_on:
      # Kafka가 healthy 상태가 된 후에만 Kafka UI 시작
      kafka:
        condition: service_healthy
    ports:
      # 웹 UI 접속용 포트 (브라우저에서 localhost:8080으로 접속)
      - "8080:8080"
    environment:
      # 위에서 정의한 내부 포트번호로 연결
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:10516
      # Kafka UI 서버 포트
      SERVER_PORT: 8080
    networks:
      # Kafka와 통신하기 위한 네트워크
      - kafka-network

# Docker 네트워크 설정
networks:
  # Kafka와 Zookeeper가 통신할 수 있는 브리지 네트워크
  kafka-network:
    # 브리지 드라이버 사용 (같은 호스트 내 컨테이너 간 통신)
    driver: bridge

# docker-compose  명령어
# docker compose up -d 실행
# docker compose down 종료  
# docker compose down -v 종료 후 모든 컨테이너 삭제
# docker compose down -v --rmi all 종료 후 모든 컨테이너 삭제 후 이미지 삭제
# docker compose down -v --rmi all --volumes 종료 후 모든 컨테이너 삭제 후 이미지 삭제 후 모든 볼륨 삭제

# Zookeeper가 하는 일
  # Kafka 브로커 관리
  # Kafka 클러스터 안에 몇 개 브로커가 있는지 관리
  # 새로운 브로커가 들어오거나 나갈 때 알려줌
# 리더/팔로워 관리
  # 각 파티션마다 리더와 팔로워를 정함
  # 클러스터 내 장애가 발생하면 자동으로 리더 재선정
# 메타데이터 저장
  # 토픽, 파티션, 오프셋 등 중요한 정보를 저장
  # Kafka 브로커는 자체적으로 상태를 완전히 관리하지 않음
# 컨슈머 그룹 관리
  # 어느 컨슈머가 어떤 파티션을 읽고 있는지 추적